# Context-OS 开发环境 Docker Compose 配置
#
# 功能：
# - ONEAPI 网关：统一管理所有 LLM 和 Embedding 调用
# - Qdrant 向量数据库：存储文档向量
# - Next.js 应用（可选）：容器化部署
#
# 使用方式：
#   docker-compose up -d          # 启动所有服务
#   docker-compose ps              # 查看状态
#   docker-compose logs -f         # 查看日志
#   docker-compose down            # 停止服务

services:
  # ============================================
  # LiteLLM Proxy Server - 统一 API 管理平台
  # ============================================
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: context-os-litellm
    ports:
      - "127.0.0.1:4410:4000"
    environment:
      - LITELLM_API_KEY=local-dev
      - SILICONFLOW_API_KEY=sk-owlyagtddajzlqjxhxsuwitpnrjvbwkrfqgjgqaspwznnfek
      - SILICONFLOW_BASE_URL=https://api.siliconflow.cn/v1
      - DASHSCOPE_API_KEY=sk-292b16fbc7b34cb9b82ec3293aa3717e
      - DEEPSEEK_API_KEY=sk-87ba9837115b4c618b08fd4abfbdf514

    volumes:
      # 配置文件挂载
      - ./litellm-config.yaml:/app/config.yaml

    command: ["--config", "/app/config.yaml", "--port", "4000", "--detailed_debug"]

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:4000/health')\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - context-os-network

  # ============================================
  # Qdrant 向量数据库
  # ============================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: context-os-qdrant
    ports:
      # HTTP API
      - "6333:6333"
      # gRPC API（可选）
      - "6334:6334"

    environment:
      # Qdrant 配置
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO

    volumes:
      # 数据持久化（保持兼容性）
      - ./qdrant_storage:/qdrant/storage

    restart: unless-stopped
    networks:
      - context-os-network

  # ============================================
  # Next.js 应用（可选，本地开发可注释）
  # ============================================
  # nextjs:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: context-os-app
  #   ports:
  #     - "3010:3000"
  #
  #   environment:
  #     # LiteLLM 网关地址（容器内部使用服务名）
  #     - LITELLM_BASE_URL=http://litellm:4000
  #     - LITELLM_API_KEY=${LITELLM_API_KEY}
  #
  #     # Qdrant 地址（容器内部使用服务名）
  #     - QDRANT_URL=http://qdrant:6333
  #
  #     # 数据库配置
  #     - DATABASE_URL=file:///data/context-os.db
  #
  #     # Node 环境
  #     - NODE_ENV=production
  #
  #   volumes:
  #     # 数据持久化
  #     - ./data/context-os.db:/app/data/context-os.db
  #
  #   depends_on:
  #     litellm:
  #       condition: service_healthy
  #     qdrant:
  #       condition: service_healthy
  #
  #   restart: unless-stopped
  #
  #   networks:
  #     - context-os-network

  # ============================================
  # Redis (可选，用于缓存和队列)
  # ============================================
  # redis:
  #   image: redis:7-alpine
  #   container_name: context-os-redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - ./redis_data:/data
  #   restart: unless-stopped
  #   networks:
  #     - context-os-network

# ============================================
# 网络配置
# ============================================
networks:
  context-os-network:
    driver: bridge
    name: context-os-network

# ============================================
# 数据卷配置（保持向后兼容）
# ============================================
volumes:
  qdrant_storage:
  # redis_data:
