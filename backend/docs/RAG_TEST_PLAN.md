# RAG 系统全链路测试计划

## 📊 测试范围

### 测试模块
1. **文档上传模块**
   - 支持的格式：PDF, TXT, MD, DOCX
   - 文件大小限制
   - 并发上传
   - 错误处理

2. **文档处理模块**
   - 文本提取
   - 分块（Chunking）
   - 向量化（Embedding）
   - 存储到 Qdrant

3. **检索模块**
   - 语义搜索
   - 混合检索（语义 + 关键词）
   - 重排序（Reranking）
   - 相关性评分

4. **生成模块**
   - Prompt 构建
   - 上下文注入
   - 流式输出
   - 引用标注

### 测试环境
- **本地环境**: http://localhost:3000
- **数据库**: SQLite (data/context-os.db)
- **向量库**: Qdrant (http://localhost:6333)
- **LLM**: OneAPI (http://localhost:3000/v1)

---

## 🧪 功能测试用例

### Test Case 1: 文档上传 - 基础功能

**优先级**: P0 (必须通过)

**前置条件**:
- 已登录系统
- 已创建知识库

**测试步骤**:
1. 访问知识库详情页
2. 点击"上传文档"按钮
3. 选择测试文件（PDF/TXT/MD）
4. 等待上传完成

**预期结果**:
- ✅ 上传进度条正常显示
- ✅ 上传成功后显示成功提示
- ✅ 文档列表中显示新上传的文档
- ✅ 文档状态显示"处理中"

**实际结果**: _待测试_

---

### Test Case 2: 文档处理 - 完整流程

**优先级**: P0 (必须通过)

**测试步骤**:
1. 上传一个测试文档（test.pdf）
2. 观察文档状态变化
3. 检查处理日志

**预期结果**:
- ✅ 状态变化：上传中 → 处理中 → 已完成
- ✅ 处理时间：< 30 秒（10 页 PDF）
- ✅ 无错误日志
- ✅ 文档元数据正确（页数、字数、chunk 数量）

**实际结果**: _待测试_

**验证 SQL**:
```sql
-- 检查文档是否创建
SELECT id, filename, status, chunk_count, created_at
FROM documents
ORDER BY created_at DESC
LIMIT 1;

-- 检查 chunks 是否创建
SELECT COUNT(*), document_id
FROM chunks
GROUP BY document_id
ORDER BY document_id DESC
LIMIT 5;
```

---

### Test Case 3: 向量化存储

**优先级**: P0 (必须通过)

**测试步骤**:
1. 选择一个已完成的文档
2. 查询 Qdrant 集合
3. 验证向量数据

**预期结果**:
- ✅ Qdrant 中存在对应集合
- ✅ 向量数量 = chunk 数量
- ✅ 向量维度 = 1024 (BGE-M3)
- ✅ Payload 包含元数据（document_id, chunk_index, content）

**验证命令**:
```bash
# 检查集合是否存在
curl http://localhost:6333/collections

# 获取集合信息
curl http://localhost:6333/collections/user_{user_id}_vectors

# 搜索测试
curl -X POST http://localhost:6333/collections/user_{user_id}_vectors/points/search \
  -H "Content-Type: application/json" \
  -d '{
    "limit": 5,
    "with_payload": true,
    "vector": [0.1, 0.2, ...]
  }'
```

**实际结果**: _待测试_

---

### Test Case 4: 语义检索 - 准确性

**优先级**: P0 (必须通过)

**测试数据准备**:
准备一个测试文档（"人工智能基础.txt"），内容包含：
- AI 的定义
- 机器学习概念
- 深度学习应用

**测试步骤**:
1. 上传测试文档
2. 等待处理完成
3. 在搜索框输入查询

**查询 1**: "什么是人工智能？"
**预期结果**:
- ✅ 返回相关 chunks（包含 AI 定义）
- ✅ 相关性分数 > 0.7
- ✅ 引用来源正确标注

**查询 2**: "机器学习的应用"
**预期结果**:
- ✅ 返回相关 chunks（包含 ML 应用）
- ✅ 至少 2 个相关结果

**查询 3**: "不相关内容测试"（如"怎么做蛋糕"）
**预期结果**:
- ✅ 返回空结果或低相关性结果
- ✅ 提示"未找到相关内容"

**实际结果**: _待测试_

---

### Test Case 5: RAG 问答 - 端到端

**优先级**: P0 (必须通过)

**测试场景**:
基于上传的文档进行问答

**Q1**: "文档中提到了哪些主要内容？"
**预期结果**:
- ✅ AI 回复准确总结文档内容
- ✅ 引用正确的来源
- ✅ 回复时间 < 10 秒
- ✅ 流式输出正常

**Q2**: "详细说明第三个要点"
**预期结果**:
- ✅ 准确识别第三个要点
- ✅ 提供详细解释
- ✅ 引用相关段落

**Q3**: "文档中没有的内容"
**预期结果**:
- ✅ AI 回复"文档中未找到相关信息"
- ✅ 不产生幻觉

**实际结果**: _待测试_

---

### Test Case 6: 边界情况测试

**优先级**: P1 (重要)

**6.1 空文档上传**
- 上传空文本文件
- 预期：显示错误提示"文档内容为空"

**6.2 超大文件**
- 上传 > 50MB 文件
- 预期：拒绝上传或分块处理

**6.3 特殊字符**
- 上传包含特殊字符的文档（emoji, 数学公式）
- 预期：正常处理，不崩溃

**6.4 并发上传**
- 同时上传 5 个文档
- 预期：全部成功处理，无数据混乱

**实际结果**: _待测试_

---

### Test Case 7: 错误处理

**优先级**: P1 (重要)

**7.1 格式不支持**
- 上传 .exe 文件
- 预期：显示错误"不支持的文件格式"

**7.2 网络中断**
- 上传过程中断网
- 预期：显示错误，可重新上传

**7.3 Qdrant 连接失败**
- 停止 Qdrant 服务
- 预期：显示错误"向量服务不可用"

**实际结果**: _待测试_

---

## 🚀 性能测试

### Test Case 8: 文档处理速度

**测试指标**:
| 文档类型 | 大小 | 预期处理时间 |
|---------|------|-------------|
| TXT | 1MB | < 5s |
| PDF | 10页 | < 15s |
| PDF | 50页 | < 60s |
| PDF | 100页 | < 120s |

**测试方法**:
```bash
# 记录处理时间
echo "Start: $(date)" >> processing.log
# 上传文档
echo "End: $(date)" >> processing.log
```

---

### Test Case 9: 检索响应时间

**测试指标**:
| 操作 | 预期响应时间 |
|-----|-------------|
| 向量搜索 | < 500ms |
| RAG 问答（首字） | < 2s |
| RAG 问答（完成） | < 10s |

**测试方法**:
```bash
# 使用 curl 测试 API 响应时间
time curl -X POST http://localhost:3000/api/chat/stream \
  -H "Content-Type: application/json" \
  -d '{"message": "测试消息"}'
```

---

## 🔍 回归测试

### Test Case 10: 多轮对话

**场景**: 基于上下文的多轮问答

**Q1**: "文档中提到了哪些技术？"
**A1**: [回答]

**Q2**: "第一项技术的原理是什么？"
**预期**:
- ✅ 理解"第一项技术"指 Q1 中的第一项
- ✅ 准确回答原理
- ✅ 引用相关段落

---

## 📊 测试报告模板

### 测试执行记录

| 用例编号 | 用例名称 | 优先级 | 执行人 | 执行日期 | 结果 | 备注 |
|---------|---------|-------|-------|---------|------|-----|
| TC-001 | 文档上传 - 基础功能 | P0 | | | ☐ Pass ☐ Fail | |
| TC-002 | 文档处理 - 完整流程 | P0 | | | ☐ Pass ☐ Fail | |
| TC-003 | 向量化存储 | P0 | | | ☐ Pass ☐ Fail | |
| TC-004 | 语义检索 - 准确性 | P0 | | | ☐ Pass ☐ Fail | |
| TC-005 | RAG 问答 - 端到端 | P0 | | | ☐ Pass ☐ Fail | |

### 缺陷报告模板

**缺陷 ID**: BUG-001
**标题**: [简短描述]
**严重程度**: [Critical / High / Medium / Low]
**优先级**: [P0 / P1 / P2 / P3]
**重现步骤**:
1.
2.
3.

**预期结果**:
**实际结果**:
**环境信息**:
- OS:
- Browser:
- Node Version:

**附件**: [截图 / 日志]

---

## ✅ 测试完成标准

### 必须通过的用例（P0）
- ✅ TC-001: 文档上传基础功能
- ✅ TC-002: 文档处理完整流程
- ✅ TC-003: 向量化存储
- ✅ TC-004: 语义检索准确性
- ✅ TC-005: RAG 问答端到端

### 性能指标
- ✅ 10 页 PDF 处理时间 < 30s
- ✅ 检索响应时间 < 500ms
- ✅ RAG 问答首字时间 < 2s

### 稳定性指标
- ✅ 连续处理 10 个文档无崩溃
- ✅ 100 次检索无错误
- ✅ 内存使用稳定（无内存泄漏）

---

## 📝 测试数据准备

### 推荐测试文档

1. **AI_基础.txt** (简单文本)
   - 内容：AI、ML、DL 基础概念
   - 用途：验证基础功能

2. **深度学习论文.pdf** (复杂文档)
   - 内容：学术论文
   - 用途：验证复杂文档处理

3. **中英文混合.md** (多语言)
   - 内容：中英文混合
   - 用途：验证多语言支持

4. **特殊字符.txt** (边界测试)
   - 内容：emoji、公式、代码
   - 用途：验证特殊字符处理

---

## 🔧 测试工具

### 推荐工具
1. **Postman / Insomnia**: API 测试
2. **Qdrant Console**: 向量检索测试
3. **SQLite Browser**: 数据库查看
4. **Lighthouse**: 性能测试
5. **React DevTools**: 组件调试

### 测试脚本

参见 `scripts/test-rag-e2e.ts`

---

## 📅 测试时间表

| 阶段 | 任务 | 预计时间 | 负责人 |
|-----|------|---------|-------|
| Day 1 | 环境准备 + 测试数据准备 | 2h | |
| Day 1-2 | 功能测试（TC-001 ~ TC-007） | 8h | |
| Day 2 | 性能测试（TC-008 ~ TC-009） | 4h | |
| Day 3 | 回归测试 + 缺陷修复 | 8h | |
| Day 3 | 测试报告 + 验收 | 2h | |

---

## 🎯 验收标准

### 功能验收
- [ ] 所有 P0 用例通过
- [ ] P1 用例通过率 > 80%
- [ ] 无 Critical 级别缺陷

### 性能验收
- [ ] 文档处理速度达标
- [ ] 检索响应时间达标
- [ ] 无明显性能瓶颈

### 稳定性验收
- [ ] 连续运行 24 小时无崩溃
- [ ] 内存使用稳定
- [ ] 无数据丢失

---

**文档版本**: v1.0
**最后更新**: 2025-01-13
**维护人**: Context-OS Team
