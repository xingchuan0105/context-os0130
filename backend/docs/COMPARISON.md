# Context OS 部署方案对比

## 📊 三种部署方案对比

### 方案A：纯腾讯云方案（PRD标准方案）

**架构**：
```
腾讯云全家桶
├── 轻量服务器A (2C2G) - Next.js + SQLite
├── 轻量服务器B (2C2G) - Qdrant
├── COS对象存储 - 文件存储
├── TDMQ - 消息队列
└── SCF - 文档处理
```

**成本**：¥210-370/月

**优势**：
- ✅ 统一云厂商，管理简单
- ✅ 内网互通，延迟低
- ✅ 完全自动化，运维简单
- ✅ 按需计费，成本可控

**劣势**：
- ❌ 单云依赖，容灾风险
- ❌ SCF冷启动可能有延迟
- ❌ TDMQ配置复杂

---

### 方案B：混合云方案（你的实际方案）⭐

**架构**：
```
阿里云
├── ECS服务器
│   ├── Coolify - 服务管理
│   ├── ONEAPI - LLM网关
│   └── Redis - 缓存

腾讯云
├── 轻量服务器 (2C2G) - Next.js + SQLite
├── 挂载存储桶 - 文件存储
└── Qdrant服务器 (可选) - 向量库
```

**成本**：¥70-150/月

**优势**：
- ✅ 成本更低（节省¥100+/月）
- ✅ 利用Coolify简化部署
- ✅ 多云部署，降低单点风险
- ✅ ONEAPI统一管理多个LLM
- ✅ Redis提供缓存加速

**劣势**：
- ❌ 跨云访问有延迟（20-100ms）
- ❌ 网络配置更复杂
- ❌ 需要配置跨云安全组
- ❌ 运维分散在两个平台

---

### 方案C：简化版（最小成本）

**架构**：
```
单台服务器（阿里云或腾讯云）
├── Next.js + SQLite
├── 挂载存储
├── Qdrant (Docker)
└── ONEAPI (Docker)
```

**成本**：¥50-100/月

**优势**：
- ✅ 成本最低
- ✅ 部署最简单
- ✅ 单机管理方便

**劣势**：
- ❌ 单点故障风险
- ❌ 扩展性差
- ❌ 无法应对高并发

---

## 🎯 推荐方案

### 对于你的情况（已有阿里云ECS）

**推荐：方案B - 混合云方案** ⭐

**理由**：
1. ✅ 利用已有阿里云ECS资源
2. ✅ Coolify简化服务部署和管理
3. ✅ ONEAPI集中管理LLM（可接入多个模型）
4. ✅ Redis提升性能（缓存、会话）
5. ✅ 挂载存储简化文件管理
6. ✅ 成本比纯腾讯云方案节省¥100+/月

---

## 📝 详细配置清单

### 阿里云ECS（已有）

**需要部署的服务**：

#### 1. Coolify（服务管理）
- 端口：8000
- 用途：容器化部署管理平台
- 内存：512MB-1GB

#### 2. ONEAPI（LLM网关）
- 端口：3001
- 用途：统一管理OpenAI、DeepSeek等LLM
- 内存：512MB
- 数据库：MySQL（Docker）

#### 3. Redis（缓存）
- 端口：6379
- 用途：会话存储、查询缓存
- 内存：256MB-512MB
- 持久化：AOF

**防火墙规则**：
```bash
# 仅允许腾讯云服务器访问
端口 3001 → 仅腾讯云IP
端口 6379 → 仅腾讯云IP
端口 8000 → 仅你的管理IP
```

---

### 腾讯云轻量服务器（需要购买）

**配置**：
- CPU：2核
- 内存：2GB
- 存储：50GB SSD
- 镜像：CentOS 8.4 或 Ubuntu 20.04
- 地域：广州/上海

**需要部署的服务**：

#### 1. Next.js应用
- 端口：3000（内部）+ 80/443（对外）
- 用途：Context OS前端
- 内存：1GB

#### 2. SQLite数据库
- 路径：/var/www/context-os/data/
- 用途：元数据存储

#### 3. 挂载存储桶
- 路径：/mnt/cos-storage
- 用途：文件存储
- 方式：CFS / rclone / cos-fuse

#### 4. Qdrant（可选）
- 端口：6333/6334
- 用途：向量数据库
- 部署：Docker

**防火墙规则**：
```bash
端口 80/443 → 0.0.0.0/0  (Web访问)
端口 22 → 仅你的IP    (SSH管理)
```

---

## 🔧 网络配置

### 跨云通信

```
阿里云ECS (公网: A.A.A.A)
  ├── ONEAPI: http://A.A.A.A:3001
  └── Redis:   redis://A.A.A.A:6379

腾讯云服务器 (公网: B.B.B.B, 内网: C.C.C.C)
  ├── Next.js: https://yourdomain.com
  └── Qdrant:  http://C.C.C.C:6333 (如果有独立服务器)
```

### 互连方式

**方式1: 公网互连（简单）**
```bash
# 腾讯云 → 阿里云
ONEAPI_BASE_URL=http://A.A.A.A:3001
REDIS_HOST=A.A.A.A
```

**方式2: 内网互连（如果支持）**
```bash
# 需要云厂商提供专线或VPN
# 延迟更低，但配置复杂
```

---

## 💰 成本分析

### 方案B - 混合云（推荐）

| 资源 | 配置 | 月成本 | 年成本 |
|------|------|--------|--------|
| 阿里云ECS（已有） | - | ¥0 | ¥0 |
| 腾讯云轻量服务器 | 2C2G 50GB | ¥50 | ¥500 |
| COS存储 | 50GB | ¥10-20 | ¥120-240 |
| Qdrant服务器（可选） | 2C2G 50GB | ¥70 | ¥700 |
| 域名+SSL | .com | ¥10-50 | ¥120-600 |
| **总计**（无Qdrant） | | **¥70-120** | **¥740-1340** |
| **总计**（有Qdrant） | | **¥140-190** | **¥1440-2040** |

**节省**：相比纯腾讯云方案节省¥100-150/月

---

## 🚀 部署步骤

### 快速部署路径

**第1步：在阿里云部署Coolify和ONEAPI**（1小时）
```bash
# 参考 docs/COOLIFY_DEPLOYMENT.md
1. 安装Coolify
2. 部署ONEAPI
3. 部署Redis
4. 配置安全组
```

**第2步：购买腾讯云轻量服务器**（30分钟）
```bash
# 购买并初始化
1. 购买轻量服务器（2C2G）
2. 配置COS存储桶
3. 挂载存储到服务器
```

**第3步：部署Context OS**（1小时）
```bash
# 参考 docs/HYBRID_CLOUD_SETUP.md
1. 安装Node.js和依赖
2. 配置环境变量
3. 部署代码
4. 配置Nginx和SSL
5. 测试验证
```

**总耗时**: 2.5-3小时

---

## ✅ 配置完成后你会得到

### 功能完整性
- ✅ 用户注册/登录（JWT认证）
- ✅ 知识库管理
- ✅ 文档上传（到挂载存储）
- ✅ 文档处理（异步或手动触发）
- ✅ 三层向量搜索
- ✅ 多LLM支持（通过ONEAPI）
- ✅ Redis缓存加速

### 运维便利性
- ✅ Coolify统一管理服务
- ✅ 自动备份脚本
- ✅ 健康检查
- ✅ 日志集中查看

### 性能特点
- ✅ 跨云延迟：20-100ms（LLM调用）
- ✅ 本地访问：<10ms（文件读取）
- ✅ 搜索响应：<500ms（向量搜索）

---

## 🔄 后续迁移路径

如果后续需要：

### 1. 完全迁移到腾讯云
- 将ONEAPI和Redis迁移到腾讯云
- 取消阿里云ECS
- 转为纯腾讯云方案

### 2. 优化混合云架构
- 使用云专线连接（降低延迟）
- 部署CDN加速
- 添加负载均衡

### 3. 多云容灾
- 部署到多个云厂商
- 配置故障切换
- 实现自动备份和恢复

---

## 📞 技术支持

**文档索引**：
- `docs/HYBRID_CLOUD_SETUP.md` - 混合云部署详解
- `docs/COOLIFY_DEPLOYMENT.md` - Coolify部署指南
- `docs/TENCENT_CLOUD_SETUP.md` - 纯腾讯云方案
- `docs/QUICK_REFERENCE.md` - 快速参考

**问题反馈**：
- GitHub Issues
- 项目文档
- 云厂商技术支持

---

**推荐行动**：先按混合云方案部署，后续根据实际需求调整
