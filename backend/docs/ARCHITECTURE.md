# Context-OS 架构说明

## 系统架构

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Browser   │────▶│  Frontend   │────▶│   Backend   │
│             │◀────│  (Next.js)  │◀────│  (Next.js)  │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
              ┌────────────────────────────────┼────────────────────────────────┐
              │                                │                                │
              ▼                                ▼                                ▼
        ┌─────────┐                      ┌─────────┐                      ┌──────────┐
        │  SQLite │                      │  Redis  │                      │ LiteLLM  │
        │  (用户) │                      │ (队列)  │                      │  (AI)    │
        └─────────┘                      └────┬────┘                      └──────────┘
                                              │
                                              ▼
                                        ┌─────────┐
                                        │ Worker  │
                                        │(文档处理)│
                                        └────┬────┘
                                              │
                              ┌───────────────┼───────────────┐
                              ▼               ▼               ▼
                        ┌─────────┐     ┌─────────┐     ┌──────────┐
                        │ Qdrant  │     │ LiteLLM │     │  Email   │
                        │ (向量)  │     │  (AI)   │     │ (SMTP)   │
                        └─────────┘     └─────────┘     └──────────┘
```

---

## Docker 部署架构

```
docker-compose.dev.yml
├── backend (端口 3002)      # Next.js API 服务
├── worker                   # 文档处理 Worker
├── frontend (端口 3003)     # Next.js 前端
├── litellm (端口 4410)      # LLM 代理服务
├── qdrant                   # 向量数据库
└── redis                    # 任务队列
```

---

## 模块说明

### 1. 认证模块 (`lib/auth/`)

- **JWT Token**: 使用 `jose` 库生成和验证
- **密码哈希**: PBKDF2-SHA256 (600,000 迭代)
- **Session**: 基于 Cookie 的会话管理
- **输入验证**: Zod schema 验证 (`lib/auth/validation.ts`)

### 2. 文档处理 (`lib/processors/`)

- **解析**: 支持 PDF、DOCX、TXT、Markdown
- **K-Type 分析**: 5 维认知摘要
- **分块**: 父子分块策略
  - 父块: 1600 字符, 240 重叠
  - 子块: 420 字符, 120 重叠
- **向量化**: Qwen3-embedding-4b

### 3. RAG 检索 (`lib/rag/`)

- **向量搜索**: Qdrant 相似度搜索
- **混合检索**: 向量 + 关键词
- **重排序**: Qwen3-reranker-4b

### 4. API 层 (`app/api/`)

- RESTful API 设计
- 统一错误处理
- 速率限制 (Redis)

### 5. 邮件模块 (`lib/email/`)

- **SMTP 发送**: 支持 163、QQ、Gmail 等
- **模板**: 密码重置邮件模板
- **配置**: 通过环境变量配置

### 6. 文件验证 (`lib/utils/file-validation.ts`)

- **Magic Bytes**: 文件类型验证
- **大小限制**: 可配置的文件大小限制
- **扩展名**: 白名单验证

### 7. 任务队列 (`lib/queue/`)

- **BullMQ**: 基于 Redis 的任务队列
- **Worker**: 独立的文档处理进程
- **重试**: 失败任务自动重试

---

## 数据流

### 文档上传
```
文件 → 验证(Magic Bytes) → 解析 → K-Type → 分块 → 向量化 → Qdrant
         ↓
      Redis 队列 → Worker 异步处理
```

### 问答
```
问题 → 检索(Qdrant) → 重排序 → LLM → 回答
```

### 密码重置
```
请求重置 → 生成 Token → 发送邮件(SMTP)
                           ↓
验证 Token → 更新密码 → 返回成功
```
