# RAG 召回自动化测试

## 快速开始

```bash
# 运行完整测试套件
npm run test:rag

# 指定用户和知识库
TEST_USER_ID=xxx TEST_KB_ID=xxx npm run test:rag

# 只测试特定分类
TEST_CATEGORIES=factual,conceptual npm run test:rag

# 输出 Markdown 格式报告
TEST_OUTPUT_FORMAT=markdown npm run test:rag
```

## 测试用例说明

### 用例分类

| 分类 | 用例数 | 说明 |
|------|--------|------|
| `factual` | 5 | 事实性查询（是什么、有多少） |
| `conceptual` | 5 | 概念性查询（定义、区别） |
| `procedural` | 5 | 程序性查询（如何做、步骤） |
| `comparative` | 4 | 比较性查询（对比、优劣） |
| `complex` | 4 | 综合性查询（原因、关系） |
| `boundary` | 5 | 边界情况（无关、歧义、过短） |
| `multi-doc` | 3 | 多文档筛选查询 |
| **总计** | **31** | |

### 用例列表

#### 事实性查询 (Factual)

| ID | 查询 | 验证点 |
|----|------|--------|
| F1 | ContextOS 支持哪些文件格式？ | pdf, docx, txt, md |
| F2 | BAAI/bge-m3 模型的向量维度是多少？ | 1024 |
| F3 | Qdrant 默认的端口是什么？ | 6333 |
| F4 | 向量检索使用的距离度量是什么？ | cosine |
| F5 | KTYPE 分析有哪几个维度？ | dominantType, knowledgeModules... |

#### 概念性查询 (Conceptual)

| ID | 查询 | 验证点 |
|----|------|--------|
| C1 | 什么是 KTYPE 认知分析？ | 定义+解释 |
| C2 | 什么是父子分块策略？ | 父块、子块概念 |
| C3 | 什么是三层RAG检索架构？ | document/parent/child |
| C4 | 向量数据库和关系数据库有什么区别？ | 对比说明 |
| C5 | executiveSummary 是什么？ | 摘要概念 |

#### 程序性查询 (Procedural)

| ID | 查询 | 验证点 |
|----|------|--------|
| P1 | 如何上传文档到知识库？ | 上传步骤 |
| P2 | 如何配置 Qdrant 向量数据库？ | 配置步骤 |
| P3 | 如何创建一个新的知识库？ | 创建步骤 |
| P4 | 文档上传失败怎么处理？ | 故障排查 |
| P5 | 如何使用选中文档功能进行对话？ | 文档筛选 |

#### 比较性查询 (Comparative)

| ID | 查询 | 验证点 |
|----|------|--------|
| CP1 | 父子分块和普通分块有什么区别？ | 分块策略对比 |
| CP2 | Cosine 和 Euclidean 哪个更适合？ | 距离度量对比 |
| CP3 | COS 和本地存储有什么区别？ | 存储方案对比 |
| CP4 | 三层检索和直接检索子块哪个更好？ | 检索策略对比 |

#### 综合性查询 (Complex)

| ID | 查询 | 验证点 |
|----|------|--------|
| X1 | 为什么要用三层RAG检索？ | 设计意图 |
| X2 | 完整的文档处理流程是什么？ | 端到端流程 |
| X3 | KTYPE 分析结果如何影响检索质量？ | 因果关系 |
| X4 | ContextOS 的技术架构包含哪些组件？ | 系统架构 |

#### 边界情况 (Boundary)

| ID | 查询 | 类型 | 预期行为 |
|----|------|------|----------|
| B1 | 量子力学的基本原理是什么？ | 无关 | 返回空或低分 |
| B2 | 部署 | 歧义 | 返回多个相关章节 |
| B3 | a | 过短 | 返回空 |
| B4 | 怎么找到去年上传的PDF并重新索引？ | 复杂 | 多步骤 |
| B5 | 系统支持哪些语言？ | 无答案 | 返回空 |

## 评估指标

### 相关性评分

```
综合得分 = 预期结果达标(30%) + 关键词匹配(40%) + 层级匹配(30%)
```

### 等级标准

| 等级 | 得分范围 | 说明 |
|------|----------|------|
| 优秀 ⭐⭐⭐ | ≥85% | 召回质量优秀 |
| 良好 ⭐⭐ | 70%-84% | 召回质量良好 |
| 及格 ⭐ | 55%-69% | 召回质量基本达标 |
| 不及格 | <55% | 需要优化 |

## 输出示例

```
══════════════════════════════════════════════════════════════
                    RAG 召回测试报告
══════════════════════════════════════════════════════════════

📊 测试概览
────────────────────────────────────────────────
  总用例数:    31
  通过数:      26
  失败数:      5
  通过率:      83.9%
  综合得分:    76.5%
  平均延迟:    423ms
  P95延迟:     892ms

🏆 等级评定: 良好 ⭐⭐

📁 按分类统计
────────────────────────────────────────────────
  factual      5/5   ████████████ 100%  (得分: 88%)
  conceptual   4/5   ██████████  80%   (得分: 75%)
  procedural   4/5   ██████████  80%   (得分: 72%)
  comparative  3/4   ████████    75%   (得分: 70%)
  complex      3/4   ████████    75%   (得分: 68%)
  boundary     4/5   ██████████  80%   (得分: 78%)
  multi-doc    3/3   ████████████ 100%  (得分: 85%)

💡 优化建议
────────────────────────────────────────────────
  1. 概念性查询召回不足，建议增强文档层(KTYPE摘要)的质量
  2. 综合性查询召回不足，建议增加文档间的关联
  3. 系统表现良好，继续保持当前配置
```

## 环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `TEST_USER_ID` | 测试用户ID | 默认用户 |
| `TEST_KB_ID` | 测试知识库ID | 未指定（搜索全部） |
| `TEST_CATEGORIES` | 测试分类（逗号分隔） | 全部 |
| `TEST_OUTPUT_FORMAT` | 输出格式 | text |

## 扩展用例

在 `test-cases.ts` 中添加新用例：

```typescript
{
  id: 'F6',
  query: '你的问题',
  category: 'factual',
  difficulty: 'easy',
  description: '用例描述',
  expected: {
    minResults: 1,
    expectedKeywords: ['关键词1', '关键词2'],
    relevantLayers: ['child'],
  },
}
```
